<?php

namespace App\Services;

use App\Models\FacebookAccount;
use App\Models\AdvertisingPlan;
use Illuminate\Support\Facades\Log;
use Exception;

class CampaignParserService
{
    protected array $validObjectives = [
        'TRAFFIC', 'CONVERSIONES', 'CONVERSIONS', 'ALCANCE', 'REACH', 
        'BRAND_AWARENESS', 'ENGAGEMENT', 'LEAD_GENERATION', 'SALES',
        'TR√ÅFICO', 'CONVERSIONES', 'ALCANCE', 'CONCIENCIA_MARCA', 
        'COMPROMISO', 'GENERACI√ìN_LEADS', 'VENTAS'
    ];

    protected array $objectiveMapping = [
        'TR√ÅFICO' => 'TRAFFIC',
        'CONVERSIONES' => 'CONVERSIONS',
        'ALCANCE' => 'REACH',
        'CONCIENCIA_MARCA' => 'BRAND_AWARENESS',
        'COMPROMISO' => 'ENGAGEMENT',
        'GENERACI√ìN_LEADS' => 'LEAD_GENERATION',
        'VENTAS' => 'SALES',
    ];

    public function parseCampaignData(string $message): array
    {
        try {
            Log::info('üîç Iniciando parseo de datos de campa√±a', [
                'message' => $message,
                'timestamp' => now()
            ]);

            $data = [
                'name' => null,
                'objective' => null,
                'daily_budget' => null,
                'duration_days' => null,
                'facebook_account' => null,
                'start_date' => null,
                'end_date' => null,
                'raw_data' => $message,
                'parsed_at' => now(),
                'errors' => [],
                'warnings' => []
            ];

            // Extraer nombre de campa√±a
            $data['name'] = $this->extractCampaignName($message);
            
            // Extraer objetivo
            $data['objective'] = $this->extractObjective($message);
            
            // Extraer presupuesto diario
            $data['daily_budget'] = $this->extractDailyBudget($message);
            
            // Extraer duraci√≥n
            $data['duration_days'] = $this->extractDuration($message);
            
            // Extraer cuenta de Facebook
            $data['facebook_account'] = $this->extractFacebookAccount($message);
            
            // Extraer fechas
            $dates = $this->extractDates($message);
            $data['start_date'] = $dates['start_date'];
            $data['end_date'] = $dates['end_date'];

            // Validar datos
            $this->validateCampaignData($data);

            Log::info('‚úÖ Datos de campa√±a parseados exitosamente', [
                'parsed_data' => $data,
                'timestamp' => now()
            ]);

            return $data;

        } catch (Exception $e) {
            Log::error('‚ùå Error parseando datos de campa√±a', [
                'error' => $e->getMessage(),
                'message' => $message,
                'trace' => $e->getTraceAsString()
            ]);
            
            throw $e;
        }
    }

    private function extractCampaignName(string $message): ?string
    {
        // Buscar patrones como "Nombre: ..." o "Name: ..."
        $patterns = [
            '/Nombre:\s*([^|]+)/i',
            '/Name:\s*([^|]+)/i',
            '/Campaign:\s*([^|]+)/i',
            '/Campa√±a:\s*([^|]+)/i'
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $message, $matches)) {
                $name = trim($matches[1]);
                if (!empty($name)) {
                    return $name;
                }
            }
        }

        return null;
    }

    private function extractObjective(string $message): ?string
    {
        $patterns = [
            '/Objetivo:\s*([^\s]+)/i',
            '/Objective:\s*([^\s]+)/i',
            '/Goal:\s*([^\s]+)/i'
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $message, $matches)) {
                $objective = strtoupper(trim($matches[1]));
                
                // Mapear objetivo en espa√±ol a ingl√©s
                if (isset($this->objectiveMapping[$objective])) {
                    $objective = $this->objectiveMapping[$objective];
                }
                
                if (in_array($objective, $this->validObjectives)) {
                    return $objective;
                }
            }
        }

        return null;
    }

    private function extractDailyBudget(string $message): ?float
    {
        $patterns = [
            '/Presupuesto:\s*([0-9.]+)/i',
            '/Budget:\s*([0-9.]+)/i',
            '/Daily Budget:\s*([0-9.]+)/i',
            '/Presupuesto diario:\s*([0-9.]+)/i'
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $message, $matches)) {
                $budget = floatval($matches[1]);
                if ($budget > 0) {
                    return $budget;
                }
            }
        }

        return null;
    }

    private function extractDuration(string $message): ?int
    {
        $patterns = [
            '/Duraci√≥n:\s*([0-9]+)/i',
            '/Duration:\s*([0-9]+)/i',
            '/Days:\s*([0-9]+)/i',
            '/D√≠as:\s*([0-9]+)/i'
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $message, $matches)) {
                $duration = intval($matches[1]);
                if ($duration > 0) {
                    return $duration;
                }
            }
        }

        return null;
    }

    private function extractFacebookAccount(string $message): ?string
    {
        $patterns = [
            '/Cuenta:\s*([^|]+)/i',
            '/Account:\s*([^|]+)/i',
            '/Facebook:\s*([^|]+)/i',
            '/FB:\s*([^|]+)/i'
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $message, $matches)) {
                $account = trim($matches[1]);
                if (!empty($account)) {
                    return $account;
                }
            }
        }

        return null;
    }

    private function extractDates(string $message): array
    {
        $dates = ['start_date' => null, 'end_date' => null];

        // Buscar patrones de fechas como "15/09 - 19/09" o "15/09/2025 - 19/09/2025"
        $datePatterns = [
            '/(\d{1,2}\/\d{1,2})\s*-\s*(\d{1,2}\/\d{1,2})/',
            '/(\d{1,2}\/\d{1,2}\/\d{4})\s*-\s*(\d{1,2}\/\d{1,2}\/\d{4})/',
            '/(\d{4}-\d{2}-\d{2})\s*-\s*(\d{4}-\d{2}-\d{2})/'
        ];

        foreach ($datePatterns as $pattern) {
            if (preg_match($pattern, $message, $matches)) {
                try {
                    $startDate = $this->parseDate($matches[1]);
                    $endDate = $this->parseDate($matches[2]);
                    
                    if ($startDate && $endDate) {
                        $dates['start_date'] = $startDate;
                        $dates['end_date'] = $endDate;
                        break;
                    }
                } catch (Exception $e) {
                    Log::warning('Error parseando fechas', ['error' => $e->getMessage()]);
                }
            }
        }

        return $dates;
    }

    private function parseDate(string $dateString): ?string
    {
        try {
            // Si no tiene a√±o, agregar el a√±o actual
            if (!preg_match('/\d{4}/', $dateString)) {
                $dateString .= '/' . date('Y');
            }

            $date = \DateTime::createFromFormat('d/m/Y', $dateString);
            if (!$date) {
                $date = \DateTime::createFromFormat('Y-m-d', $dateString);
            }
            
            if ($date) {
                return $date->format('Y-m-d');
            }
        } catch (Exception $e) {
            Log::warning('Error parseando fecha individual', ['date' => $dateString, 'error' => $e->getMessage()]);
        }

        return null;
    }

    private function validateCampaignData(array &$data): void
    {
        $errors = [];
        $warnings = [];

        // Validar nombre
        if (empty($data['name'])) {
            $errors[] = 'Nombre de campa√±a es requerido';
        }

        // Validar objetivo
        if (empty($data['objective'])) {
            $errors[] = 'Objetivo de campa√±a es requerido';
        } elseif (!in_array($data['objective'], $this->validObjectives)) {
            $errors[] = 'Objetivo no v√°lido: ' . $data['objective'];
        }

        // Validar presupuesto
        if (empty($data['daily_budget'])) {
            $errors[] = 'Presupuesto diario es requerido';
        } elseif ($data['daily_budget'] < 1) {
            $errors[] = 'Presupuesto diario debe ser mayor a $1';
        } elseif ($data['daily_budget'] > 1000) {
            $warnings[] = 'Presupuesto diario muy alto: $' . $data['daily_budget'];
        }

        // Validar duraci√≥n
        if (empty($data['duration_days'])) {
            $errors[] = 'Duraci√≥n es requerida';
        } elseif ($data['duration_days'] < 1) {
            $errors[] = 'Duraci√≥n debe ser mayor a 0 d√≠as';
        } elseif ($data['duration_days'] > 365) {
            $warnings[] = 'Duraci√≥n muy larga: ' . $data['duration_days'] . ' d√≠as';
        }

        // Validar cuenta de Facebook
        if (empty($data['facebook_account'])) {
            $errors[] = 'Cuenta de Facebook es requerida';
        } else {
            // Verificar si la cuenta existe en la base de datos
            $account = FacebookAccount::where('name', 'like', '%' . $data['facebook_account'] . '%')
                ->orWhere('account_id', 'like', '%' . $data['facebook_account'] . '%')
                ->first();
            
            if (!$account) {
                $warnings[] = 'Cuenta de Facebook no encontrada: ' . $data['facebook_account'];
            } else {
                $data['facebook_account_id'] = $account->id;
                $data['facebook_account_data'] = $account;
            }
        }

        // Validar fechas
        if ($data['start_date'] && $data['end_date']) {
            $start = new \DateTime($data['start_date']);
            $end = new \DateTime($data['end_date']);
            
            if ($start >= $end) {
                $errors[] = 'Fecha de inicio debe ser anterior a fecha de fin';
            }
            
            $diff = $start->diff($end)->days;
            if ($data['duration_days'] && $diff != $data['duration_days']) {
                $warnings[] = 'Duraci√≥n calculada (' . $diff . ' d√≠as) no coincide con duraci√≥n especificada (' . $data['duration_days'] . ' d√≠as)';
            }
        }

        $data['errors'] = $errors;
        $data['warnings'] = $warnings;
        $data['is_valid'] = empty($errors);
    }

    public function getAvailableFacebookAccounts(): array
    {
        return FacebookAccount::where('is_active', true)
            ->select('id', 'name', 'account_id', 'access_token')
            ->get()
            ->toArray();
    }

    public function getAvailableObjectives(): array
    {
        return [
            'TRAFFIC' => 'Tr√°fico al sitio web',
            'CONVERSIONS' => 'Conversiones',
            'REACH' => 'Alcance',
            'BRAND_AWARENESS' => 'Conciencia de marca',
            'ENGAGEMENT' => 'Compromiso',
            'LEAD_GENERATION' => 'Generaci√≥n de leads',
            'SALES' => 'Ventas'
        ];
    }

    public function formatCampaignSummary(array $data): string
    {
        $summary = "üìä *Resumen de Campa√±a*\n\n";
        
        $summary .= "üè∑Ô∏è *Nombre:* " . ($data['name'] ?? 'No especificado') . "\n";
        $summary .= "üéØ *Objetivo:* " . ($data['objective'] ?? 'No especificado') . "\n";
        $summary .= "üí∞ *Presupuesto diario:* $" . ($data['daily_budget'] ?? 'No especificado') . "\n";
        $summary .= "üìÖ *Duraci√≥n:* " . ($data['duration_days'] ?? 'No especificado') . " d√≠as\n";
        $summary .= "üì± *Cuenta FB:* " . ($data['facebook_account'] ?? 'No especificada') . "\n";
        
        if ($data['start_date'] && $data['end_date']) {
            $summary .= "üìÜ *Fechas:* " . $data['start_date'] . " - " . $data['end_date'] . "\n";
        }
        
        $summary .= "\n";
        
        if (!empty($data['errors'])) {
            $summary .= "‚ùå *Errores:*\n";
            foreach ($data['errors'] as $error) {
                $summary .= "‚Ä¢ " . $error . "\n";
            }
        }
        
        if (!empty($data['warnings'])) {
            $summary .= "‚ö†Ô∏è *Advertencias:*\n";
            foreach ($data['warnings'] as $warning) {
                $summary .= "‚Ä¢ " . $warning . "\n";
            }
        }
        
        return $summary;
    }
}
