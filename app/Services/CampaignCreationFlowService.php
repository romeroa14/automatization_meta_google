<?php

namespace App\Services;

use App\Models\FacebookAccount;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Cache;

class CampaignCreationFlowService
{
    protected array $steps = [
        'start' => 'Iniciar creaci√≥n de campa√±a',
        'ad_account' => 'Seleccionar cuenta publicitaria',
        'fanpage' => 'Seleccionar fanpage',
        'template_choice' => 'Elegir m√©todo de creaci√≥n',
        'template_form' => 'Formulario de plantilla',
        'campaign_name' => 'Nombre de la campa√±a',
        'campaign_objective' => 'Objetivo de la campa√±a',
        'budget_type' => 'Tipo de presupuesto',
        'daily_budget' => 'Presupuesto diario',
        'dates' => 'Fechas de la campa√±a',
        'geolocation' => 'Geolocalizaci√≥n',
        'conversion_location' => 'Ubicaci√≥n de conversi√≥n',
        'audience_type' => 'Tipo de audiencia',
        'audience_details' => 'Detalles de la audiencia',
        'ad_placement' => 'Ubicaci√≥n de anuncios',
        'ad_name' => 'Nombre del anuncio',
        'creative_type' => 'Tipo de creativo',
        'creative_content' => 'Contenido del creativo',
        'ad_copy' => 'Copy del anuncio',
        'conversation_template' => 'Plantilla de conversaci√≥n',
        'review' => 'Revisar y confirmar',
        'create' => 'Crear campa√±a'
    ];

    protected array $campaignObjectives = [
        'TRAFFIC' => 'Tr√°fico al sitio web',
        'CONVERSION' => 'Conversiones',
        'REACH' => 'Alcance',
        'BRAND_AWARENESS' => 'Conciencia de marca',
        'ENGAGEMENT' => 'Compromiso',
        'LEAD_GENERATION' => 'Generaci√≥n de leads',
        'SALES' => 'Ventas',
        'MESSAGES' => 'Mensajes',
        'APP_INSTALLS' => 'Instalaciones de app',
        'VIDEO_VIEWS' => 'Visualizaciones de video'
    ];

    protected array $budgetTypes = [
        'campaign' => 'Nivel Campa√±a',
        'adset' => 'Nivel Conjunto de Anuncios'
    ];

    protected array $audienceTypes = [
        'no_interests' => 'Sin intereses (Audiencia amplia)',
        'custom' => 'Audiencia personalizada',
        'lookalike' => 'Audiencia similar',
        'saved' => 'Audiencia guardada'
    ];

    protected array $adPlacements = [
        'automatic' => 'Advantage+ (Autom√°tico)',
        'manual' => 'Ubicaci√≥n manual'
    ];

    protected array $creativeTypes = [
        'new_image' => 'Subir nueva imagen',
        'new_video' => 'Subir nuevo video',
        'existing_post' => 'Publicaci√≥n existente de Instagram',
        'existing_facebook' => 'Publicaci√≥n existente de Facebook'
    ];

    protected array $conversationTemplates = [
        'welcome' => 'Mensaje de bienvenida',
        'product_info' => 'Informaci√≥n del producto',
        'support' => 'Soporte al cliente',
        'custom' => 'Mensaje personalizado'
    ];

    public function getStepMessage(string $step, array $data = []): string
    {
        switch ($step) {
            case 'start':
                return $this->getStartMessage();
            case 'ad_account':
                return $this->getAdAccountMessage();
            case 'fanpage':
                return $this->getFanpageMessage($data);
            case 'template_choice':
                return $this->getTemplateChoiceMessage();
            case 'template_form':
                return $this->getTemplateFormMessage();
            case 'campaign_name':
                return $this->getCampaignNameMessage();
            case 'campaign_objective':
                return $this->getCampaignObjectiveMessage();
            case 'budget_type':
                return $this->getBudgetTypeMessage();
            case 'daily_budget':
                return $this->getDailyBudgetMessage();
            case 'dates':
                return $this->getDatesMessage();
            case 'geolocation':
                return $this->getGeolocationMessage();
            case 'conversion_location':
                return $this->getConversionLocationMessage();
            case 'audience_type':
                return $this->getAudienceTypeMessage();
            case 'audience_details':
                return $this->getAudienceDetailsMessage($data);
            case 'ad_placement':
                return $this->getAdPlacementMessage();
            case 'ad_name':
                return $this->getAdNameMessage();
            case 'creative_type':
                return $this->getCreativeTypeMessage();
            case 'creative_content':
                return $this->getCreativeContentMessage($data);
            case 'ad_copy':
                return $this->getAdCopyMessage();
            case 'conversation_template':
                return $this->getConversationTemplateMessage();
            case 'review':
                return $this->getReviewMessage($data);
            default:
                return "‚ùå Paso no reconocido: {$step}";
        }
    }

    private function getStartMessage(): string
    {
        $message = "üéØ *Crear Nueva Campa√±a - Paso 1*\n\n";
        $message .= "Vamos a crear una campa√±a publicitaria paso a paso.\n\n";
        $message .= "üìã *Informaci√≥n que necesitaremos:*\n";
        $message .= "‚Ä¢ Cuenta publicitaria\n";
        $message .= "‚Ä¢ Fanpage de destino\n";
        $message .= "‚Ä¢ Nombre de la campa√±a\n";
        $message .= "‚Ä¢ Objetivo de la campa√±a\n";
        $message .= "‚Ä¢ Tipo de presupuesto\n";
        $message .= "‚Ä¢ Presupuesto diario\n";
        $message .= "‚Ä¢ Fechas de la campa√±a\n";
        $message .= "‚Ä¢ Geolocalizaci√≥n\n";
        $message .= "‚Ä¢ Configuraci√≥n de audiencia\n";
        $message .= "‚Ä¢ Ubicaci√≥n de anuncios\n";
        $message .= "‚Ä¢ Creativos y copy\n\n";
        $message .= "üöÄ *¬øEst√°s listo para comenzar?*\n";
        $message .= "Escribe 'S√ç' para continuar o 'CANCELAR' para salir.";

        return $message;
    }

    private function getAdAccountMessage(): string
    {
        $accounts = $this->getAvailableFacebookAccounts();
        
        $message = "üí∞ *Paso 2: Seleccionar Cuenta Publicitaria*\n\n";
        $message .= "Selecciona la cuenta publicitaria donde se crear√° la campa√±a:\n\n";
        
        if (empty($accounts)) {
            return $message . "‚ùå No hay cuentas publicitarias activas disponibles.";
        }
        
        foreach ($accounts as $index => $account) {
            $number = $index + 1;
            $message .= "{$number}. *{$account['account_name']}*\n";
            $message .= "   ID: `{$account['app_id']}`\n";
            $message .= "   Moneda: {$account['currency']}\n";
            $message .= "   Estado: {$account['status']}\n\n";
        }
        
        $message .= "üí° *Escribe el n√∫mero de la cuenta que deseas usar.*";

        return $message;
    }

    private function getFanpageMessage(array $data): string
    {
        // Usar paginaci√≥n por defecto (p√°gina 1)
        return $this->getFanpageMessagePaginated(1);
    }

    private function getTemplateChoiceMessage(): string
    {
        $message = "‚ö° *Paso 4: M√©todo de Creaci√≥n*\n\n";
        $message .= "¬øC√≥mo quieres crear tu campa√±a?\n\n";
        $message .= "üîÑ *Opci√≥n 1: Paso a Paso*\n";
        $message .= "‚Ä¢ Te guiar√© pregunta por pregunta\n";
        $message .= "‚Ä¢ Ideal para principiantes\n";
        $message .= "‚Ä¢ Control total sobre cada detalle\n\n";
        $message .= "üìã *Opci√≥n 2: Plantilla R√°pida*\n";
        $message .= "‚Ä¢ Completa todos los datos de una vez\n";
        $message .= "‚Ä¢ Ideal para usuarios avanzados\n";
        $message .= "‚Ä¢ Creaci√≥n m√°s r√°pida\n\n";
        $message .= "üí° *Escribe 'paso' para ir paso a paso o 'plantilla' para usar plantilla.*";

        return $message;
    }

    private function getTemplateFormMessage(): string
    {
        $message = "üìã *Plantilla de Creaci√≥n R√°pida*\n\n";
        $message .= "Copia y pega esta plantilla, luego reemplaza los valores entre corchetes:\n\n";
        $message .= "```\n";
        $message .= "NOMBRE_CAMPANA: [Mi Campa√±a 2025]\n";
        $message .= "OBJETIVO: [CONVERSION|TRAFFIC|REACH|ENGAGEMENT|SALES|LEAD_GENERATION]\n";
        $message .= "TIPO_PRESUPUESTO: [campaign|adset]\n";
        $message .= "PRESUPUESTO_DIARIO: [100]\n";
        $message .= "FECHA_INICIO: [18/09/2025]\n";
        $message .= "FECHA_FIN: [25/09/2025]\n";
        $message .= "PAIS: [Venezuela]\n";
        $message .= "CIUDAD: [Caracas]\n";
        $message .= "UBICACION_CONVERSION: [SITIO_WEB|APP|MESSENGER|WHATSAPP|FACEBOOK]\n";
        $message .= "EDAD_MIN: [18]\n";
        $message .= "EDAD_MAX: [65]\n";
        $message .= "GENERO: [ambos|hombres|mujeres]\n";
        $message .= "UBICACION_ANUNCIOS: [automatic|facebook|instagram|messenger|audience_network]\n";
        $message .= "NOMBRE_ANUNCIO: [Mi Anuncio]\n";
        $message .= "TIPO_CREATIVO: [existing_post|new_post|carousel|video]\n";
        $message .= "COPY_ANUNCIO: [Mi mensaje publicitario]\n";
        $message .= "```\n\n";
        $message .= "üìù *Ejemplo completo:*\n";
        $message .= "```\n";
        $message .= "NOMBRE_CAMPANA: Campa√±a Verano 2025\n";
        $message .= "OBJETIVO: CONVERSION\n";
        $message .= "TIPO_PRESUPUESTO: adset\n";
        $message .= "PRESUPUESTO_DIARIO: 50\n";
        $message .= "FECHA_INICIO: 20/09/2025\n";
        $message .= "FECHA_FIN: 30/09/2025\n";
        $message .= "PAIS: Venezuela\n";
        $message .= "CIUDAD: Caracas\n";
        $message .= "UBICACION_CONVERSION: SITIO_WEB\n";
        $message .= "EDAD_MIN: 25\n";
        $message .= "EDAD_MAX: 55\n";
        $message .= "GENERO: ambos\n";
        $message .= "UBICACION_ANUNCIOS: automatic\n";
        $message .= "NOMBRE_ANUNCIO: Promoci√≥n Verano\n";
        $message .= "TIPO_CREATIVO: existing_post\n";
        $message .= "COPY_ANUNCIO: ¬°Oferta especial de verano! No te la pierdas\n";
        $message .= "```\n\n";
        $message .= "üí° *Copia la plantilla, completa los datos y p√©galos aqu√≠.*";

        return $message;
    }

    private function parseTemplate(string $input): ?array
    {
        $lines = explode("\n", trim($input));
        $data = [];
        
        foreach ($lines as $line) {
            $line = trim($line);
            if (empty($line) || strpos($line, ':') === false) {
                continue;
            }
            
            [$key, $value] = explode(':', $line, 2);
            $key = trim($key);
            $value = trim($value);
            
            if (empty($key) || empty($value)) {
                continue;
            }
            
            // Mapear campos de la plantilla a campos del sistema
            switch ($key) {
                case 'NOMBRE_CAMPANA':
                    $data['campaign_name'] = $value;
                    break;
                case 'OBJETIVO':
                    $data['campaign_objective'] = $value;
                    break;
                case 'TIPO_PRESUPUESTO':
                    $data['budget_type'] = $value;
                    break;
                case 'PRESUPUESTO_DIARIO':
                    $data['daily_budget'] = floatval($value);
                    break;
                case 'FECHA_INICIO':
                    $data['start_date'] = $value;
                    break;
                case 'FECHA_FIN':
                    $data['end_date'] = $value;
                    break;
                case 'PAIS':
                    $data['country'] = $value;
                    break;
                case 'CIUDAD':
                    $data['city'] = $value;
                    break;
                case 'EDAD_MIN':
                    $data['age_min'] = intval($value);
                    break;
                case 'EDAD_MAX':
                    $data['age_max'] = intval($value);
                    break;
                case 'GENERO':
                    $data['gender'] = $value;
                    break;
                case 'UBICACION_ANUNCIOS':
                    $data['ad_placement'] = $value;
                    break;
                case 'NOMBRE_ANUNCIO':
                    $data['ad_name'] = $value;
                    break;
                case 'TIPO_CREATIVO':
                    $data['creative_type'] = $value;
                    break;
                case 'COPY_ANUNCIO':
                    $data['ad_copy'] = $value;
                    break;
                case 'UBICACION_CONVERSION':
                    $data['conversion_location'] = $value;
                    break;
            }
        }
        
        // Construir geolocalizaci√≥n
        if (isset($data['country']) && isset($data['city'])) {
            $data['geolocation'] = $data['city'] . ', ' . $data['country'];
        } elseif (isset($data['country'])) {
            $data['geolocation'] = $data['country'];
        } elseif (isset($data['city'])) {
            $data['geolocation'] = $data['city'];
        }
        
        // Validar campos requeridos
        $required = ['campaign_name', 'campaign_objective', 'budget_type', 'daily_budget', 'start_date', 'end_date'];
        foreach ($required as $field) {
            if (!isset($data[$field]) || empty($data[$field])) {
                return null;
            }
        }
        
        return $data;
    }

    private function getCampaignNameMessage(): string
    {
        $message = "üè∑Ô∏è *Paso 4: Nombre de la Campa√±a*\n\n";
        $message .= "Escribe el nombre que tendr√° tu campa√±a:\n\n";
        $message .= "üìù *Ejemplos:*\n";
        $message .= "‚Ä¢ Campa√±a Verano 2025\n";
        $message .= "‚Ä¢ Promoci√≥n Producto X\n";
        $message .= "‚Ä¢ Black Friday 2025\n\n";
        $message .= "üí° *Escribe el nombre de tu campa√±a.*";

        return $message;
    }

    private function getCampaignObjectiveMessage(): string
    {
        $message = "üéØ *Paso 5: Objetivo de la Campa√±a*\n\n";
        $message .= "Selecciona el objetivo principal de tu campa√±a:\n\n";
        
        foreach ($this->campaignObjectives as $key => $description) {
            $message .= "‚Ä¢ *{$key}*: {$description}\n";
        }
        
        $message .= "\nüí° *Escribe el c√≥digo del objetivo (ej: CONVERSIONS).*";

        return $message;
    }

    private function getBudgetTypeMessage(): string
    {
        $message = "üí∞ *Paso 6: Tipo de Presupuesto*\n\n";
        $message .= "Selecciona d√≥nde se configurar√° el presupuesto:\n\n";
        
        foreach ($this->budgetTypes as $key => $description) {
            $message .= "‚Ä¢ *{$key}*: {$description}\n";
        }
        
        $message .= "\nüìä *Explicaci√≥n:*\n";
        $message .= "‚Ä¢ *Campa√±a*: El presupuesto se distribuye entre todos los conjuntos de anuncios\n";
        $message .= "‚Ä¢ *Conjunto*: Cada conjunto de anuncios tiene su propio presupuesto\n\n";
        $message .= "üí° *Escribe 'campaign' o 'adset'.*";

        return $message;
    }

    private function getDailyBudgetMessage(): string
    {
        $message = "üíµ *Paso 7: Presupuesto Diario*\n\n";
        $message .= "Escribe el presupuesto diario en USD:\n\n";
        $message .= "üìä *Ejemplos:*\n";
        $message .= "‚Ä¢ 1 (para $1 USD por d√≠a)\n";
        $message .= "‚Ä¢ 5 (para $5 USD por d√≠a)\n";
        $message .= "‚Ä¢ 25.50 (para $25.50 USD por d√≠a)\n";
        $message .= "‚Ä¢ 100 (para $100 USD por d√≠a)\n\n";
        $message .= "üí° *Puedes usar cualquier monto que desees.*\n\n";
        $message .= "üí° *Escribe el monto del presupuesto diario.*";

        return $message;
    }

    private function getDatesMessage(): string
    {
        $message = "üìÖ *Paso 8: Fechas de la Campa√±a*\n\n";
        $message .= "Especifica las fechas de inicio y fin de tu campa√±a:\n\n";
        $message .= "üìù *Formato:*\n";
        $message .= "‚Ä¢ Fecha inicio: DD/MM/YYYY\n";
        $message .= "‚Ä¢ Fecha fin: DD/MM/YYYY\n\n";
        $message .= "üìä *Ejemplos:*\n";
        $message .= "‚Ä¢ Inicio: 20/09/2025\n";
        $message .= "‚Ä¢ Fin: 30/09/2025\n\n";
        $message .= "üí° *Escribe las fechas en el formato indicado.*";

        return $message;
    }

    private function getGeolocationMessage(): string
    {
        $message = "üåç *Paso 9: Geolocalizaci√≥n*\n\n";
        $message .= "Especifica las ubicaciones geogr√°ficas para tu campa√±a.\n\n";
        $message .= "üìù *Formato requerido para Facebook:*\n";
        $message .= "‚Ä¢ **Pa√≠s:** VE (Venezuela), US (Estados Unidos), ES (Espa√±a)\n";
        $message .= "‚Ä¢ **Ciudad:** Caracas,VE o Madrid,ES\n";
        $message .= "‚Ä¢ **Regi√≥n:** Miranda,VE o California,US\n\n";
        $message .= "üí° *Ejemplos v√°lidos:*\n";
        $message .= "‚Ä¢ VE (todo Venezuela)\n";
        $message .= "‚Ä¢ Caracas,VE (solo Caracas)\n";
        $message .= "‚Ä¢ Miranda,VE (estado Miranda)\n";
        $message .= "‚Ä¢ VE;CO (Venezuela y Colombia)\n";
        $message .= "‚Ä¢ Caracas,VE;Madrid,ES (m√∫ltiples ciudades)\n\n";
        $message .= "üí° *Escribe las ubicaciones en el formato correcto.*";

        return $message;
    }

    private function getConversionLocationMessage(): string
    {
        $message = "üéØ *Paso 10: Ubicaci√≥n de Conversi√≥n*\n\n";
        $message .= "Especifica d√≥nde quieres que ocurran las conversiones:\n\n";
        $message .= "üìç *Opciones disponibles:*\n";
        $message .= "‚Ä¢ **SITIO_WEB** - En tu sitio web\n";
        $message .= "‚Ä¢ **APP** - En tu aplicaci√≥n m√≥vil\n";
        $message .= "‚Ä¢ **MESSENGER** - En Messenger\n";
        $message .= "‚Ä¢ **WHATSAPP** - En WhatsApp\n";
        $message .= "‚Ä¢ **FACEBOOK** - En Facebook/Instagram\n\n";
        $message .= "üí° *Ejemplos:*\n";
        $message .= "‚Ä¢ SITIO_WEB (para conversiones en tu sitio)\n";
        $message .= "‚Ä¢ APP (para conversiones en tu app)\n";
        $message .= "‚Ä¢ MESSENGER (para conversaciones en Messenger)\n\n";
        $message .= "üí° *Escribe la ubicaci√≥n de conversi√≥n deseada.*";

        return $message;
    }

    private function getAudienceTypeMessage(): string
    {
        $message = "üë• *Paso 10: Tipo de Audiencia*\n\n";
        $message .= "Selecciona el tipo de audiencia para tu campa√±a:\n\n";
        
        foreach ($this->audienceTypes as $key => $description) {
            $message .= "‚Ä¢ *{$key}*: {$description}\n";
        }
        
        $message .= "\nüìä *Explicaci√≥n:*\n";
        $message .= "‚Ä¢ *Sin intereses*: Audiencia amplia, menos segmentada\n";
        $message .= "‚Ä¢ *Personalizada*: Define intereses, demograf√≠a, etc.\n";
        $message .= "‚Ä¢ *Similar*: Basada en audiencia existente\n";
        $message .= "‚Ä¢ *Guardada*: Audiencia previamente creada\n\n";
        $message .= "üí° *Escribe el tipo de audiencia que deseas usar.*";

        return $message;
    }

    private function getAudienceDetailsMessage(array $data): string
    {
        $audienceType = $data['audience_type'] ?? 'custom';
        
        $message = "üéØ *Paso 11: Detalles de la Audiencia*\n\n";
        
        switch ($audienceType) {
            case 'no_interests':
                $message .= "Configuraci√≥n para audiencia amplia:\n\n";
                $message .= "üìù *Especifica:*\n";
                $message .= "‚Ä¢ Edad m√≠nima: 18\n";
                $message .= "‚Ä¢ Edad m√°xima: 65\n";
                $message .= "‚Ä¢ G√©nero: Todos\n\n";
                break;
                
            case 'custom':
                $message .= "Configuraci√≥n para audiencia personalizada:\n\n";
                $message .= "üìù *Especifica:*\n";
                $message .= "‚Ä¢ Edad: 25-45\n";
                $message .= "‚Ä¢ G√©nero: Mujeres\n";
                $message .= "‚Ä¢ Intereses: Moda, Belleza, Lifestyle\n";
                $message .= "‚Ä¢ Comportamientos: Compradores online\n\n";
                break;
                
            case 'lookalike':
                $message .= "Configuraci√≥n para audiencia similar:\n\n";
                $message .= "üìù *Especifica:*\n";
                $message .= "‚Ä¢ Audiencia fuente: ID de audiencia\n";
                $message .= "‚Ä¢ Similitud: 1% (m√°s similar) o 10% (m√°s amplia)\n\n";
                break;
        }
        
        $message .= "üí° *Escribe los detalles de la audiencia.*";

        return $message;
    }

    private function getAdPlacementMessage(): string
    {
        $message = "üìç *Paso 12: Ubicaci√≥n de Anuncios*\n\n";
        $message .= "Selecciona d√≥nde aparecer√°n tus anuncios:\n\n";
        
        foreach ($this->adPlacements as $key => $description) {
            $message .= "‚Ä¢ *{$key}*: {$description}\n";
        }
        
        $message .= "\nüìä *Explicaci√≥n:*\n";
        $message .= "‚Ä¢ *Advantage+*: Meta optimiza autom√°ticamente\n";
        $message .= "‚Ä¢ *Manual*: T√∫ eliges las ubicaciones espec√≠ficas\n\n";
        $message .= "üí° *Escribe 'automatic' o 'manual'.*";

        return $message;
    }

    private function getAdNameMessage(): string
    {
        $message = "üè∑Ô∏è *Paso 13: Nombre del Anuncio*\n\n";
        $message .= "Escribe el nombre que tendr√° tu anuncio:\n\n";
        $message .= "üìù *Ejemplos:*\n";
        $message .= "‚Ä¢ Anuncio Principal\n";
        $message .= "‚Ä¢ Promoci√≥n Verano\n";
        $message .= "‚Ä¢ Oferta Especial\n\n";
        $message .= "üí° *Escribe el nombre de tu anuncio.*";

        return $message;
    }

    private function getCreativeTypeMessage(): string
    {
        $message = "üé® *Paso 14: Tipo de Creativo*\n\n";
        $message .= "Selecciona el tipo de creativo para tu anuncio:\n\n";
        
        foreach ($this->creativeTypes as $key => $description) {
            $message .= "‚Ä¢ *{$key}*: {$description}\n";
        }
        
        $message .= "\nüí° *Escribe el tipo de creativo que deseas usar.*";

        return $message;
    }

    private function getCreativeContentMessage(array $data): string
    {
        $creativeType = $data['creative_type'] ?? 'new_image';
        
        $message = "üì∏ *Paso 15: Contenido del Creativo*\n\n";
        
        switch ($creativeType) {
            case 'new_image':
                $message .= "Sube una nueva imagen:\n\n";
                $message .= "üìù *Especificaciones:*\n";
                $message .= "‚Ä¢ Formato: JPG, PNG\n";
                $message .= "‚Ä¢ Tama√±o: 1080x1080px (recomendado)\n";
                $message .= "‚Ä¢ Peso: M√°ximo 30MB\n\n";
                $message .= "üí° *Sube la imagen o escribe 'SALTAR' para continuar.*";
                break;
                
            case 'new_video':
                $message .= "Sube un nuevo video:\n\n";
                $message .= "üìù *Especificaciones:*\n";
                $message .= "‚Ä¢ Formato: MP4, MOV\n";
                $message .= "‚Ä¢ Duraci√≥n: 15 segundos - 2 minutos\n";
                $message .= "‚Ä¢ Peso: M√°ximo 4GB\n\n";
                $message .= "üí° *Sube el video o escribe 'SALTAR' para continuar.*";
                break;
                
            case 'existing_post':
                $message .= "Selecciona una publicaci√≥n existente de Instagram:\n\n";
                $message .= "üìù *Escribe:*\n";
                $message .= "‚Ä¢ URL de la publicaci√≥n de Instagram\n";
                $message .= "‚Ä¢ O ID de la publicaci√≥n\n\n";
                $message .= "üí° *Proporciona la URL o ID de la publicaci√≥n.*";
                break;
                
            case 'existing_facebook':
                $message .= "Selecciona una publicaci√≥n existente de Facebook:\n\n";
                $message .= "üìù *Escribe:*\n";
                $message .= "‚Ä¢ URL de la publicaci√≥n de Facebook\n";
                $message .= "‚Ä¢ O ID de la publicaci√≥n\n\n";
                $message .= "üí° *Proporciona la URL o ID de la publicaci√≥n.*";
                break;
        }

        return $message;
    }

    private function getAdCopyMessage(): string
    {
        $message = "‚úçÔ∏è *Paso 16: Copy del Anuncio*\n\n";
        $message .= "Escribe el texto que aparecer√° en tu anuncio:\n\n";
        $message .= "üìù *Ejemplos:*\n";
        $message .= "‚Ä¢ ¬°Oferta especial! 50% de descuento\n";
        $message .= "‚Ä¢ Descubre nuestra nueva colecci√≥n\n";
        $message .= "‚Ä¢ Env√≠o gratis en compras superiores a $50\n\n";
        $message .= "üí° *Escribe el copy de tu anuncio.*";

        return $message;
    }

    private function getConversationTemplateMessage(): string
    {
        $message = "üí¨ *Paso 17: Plantilla de Conversaci√≥n*\n\n";
        $message .= "Si tu objetivo es generar mensajes, selecciona la plantilla:\n\n";
        
        foreach ($this->conversationTemplates as $key => $description) {
            $message .= "‚Ä¢ *{$key}*: {$description}\n";
        }
        
        $message .= "\nüí° *Escribe el tipo de plantilla o 'SALTAR' si no aplica.*";

        return $message;
    }

    private function getReviewMessage(array $data): string
    {
        $message = "üìã *Revisi√≥n Final - Paso 18*\n\n";
        $message .= "Revisa todos los datos de tu campa√±a:\n\n";
        
        $message .= "üí∞ *Cuenta Publicitaria:* " . ($data['ad_account_name'] ?? 'No especificada') . "\n";
        $message .= "üì± *Fanpage:* " . ($data['fanpage_name'] ?? 'No especificada') . "\n";
        $message .= "üè∑Ô∏è *Nombre Campa√±a:* " . ($data['campaign_name'] ?? 'No especificado') . "\n";
        $message .= "üéØ *Objetivo:* " . ($data['campaign_objective'] ?? 'No especificado') . "\n";
        $message .= "üí∞ *Tipo Presupuesto:* " . ($data['budget_type'] ?? 'No especificado') . "\n";
        $message .= "üíµ *Presupuesto Diario:* $" . ($data['daily_budget'] ?? 'No especificado') . "\n";
        $message .= "üìÖ *Fechas:* " . ($data['start_date'] ?? 'No especificada') . " - " . ($data['end_date'] ?? 'No especificada') . "\n";
        $message .= "üåç *Geolocalizaci√≥n:* " . ($data['geolocation'] ?? 'No especificada') . "\n";
        $message .= "üéØ *Ubicaci√≥n Conversi√≥n:* " . ($data['conversion_location'] ?? 'No especificada') . "\n";
        $message .= "üë• *Audiencia:* " . ($data['audience_type'] ?? 'No especificada') . "\n";
        $message .= "üìç *Ubicaci√≥n Anuncios:* " . ($data['ad_placement'] ?? 'No especificada') . "\n";
        $message .= "üè∑Ô∏è *Nombre Anuncio:* " . ($data['ad_name'] ?? 'No especificado') . "\n";
        $message .= "üé® *Tipo Creativo:* " . ($data['creative_type'] ?? 'No especificado') . "\n";
        $message .= "‚úçÔ∏è *Copy:* " . ($data['ad_copy'] ?? 'No especificado') . "\n\n";
        
        $message .= "‚úÖ *¬øTodo est√° correcto?*\n";
        $message .= "Escribe 'CONFIRMAR' para crear la campa√±a o 'EDITAR' para modificar algo.";

        return $message;
    }

    private function getAvailableAdAccounts(): array
    {
        // Aqu√≠ obtendr√≠amos las cuentas publicitarias reales de Meta API
        // Por ahora retornamos datos de ejemplo
        return [
            [
                'id' => 'act_123456789',
                'name' => 'ADMETRICAS.COM - Cuenta Principal',
                'currency' => 'USD'
            ]
        ];
    }

    

    public function getSteps(): array
    {
        return $this->steps;
    }

    public function getNextStep(string $currentStep): string
    {
        $steps = array_keys($this->steps);
        $currentIndex = array_search($currentStep, $steps);
        
        if ($currentIndex !== false && $currentIndex < count($steps) - 1) {
            return $steps[$currentIndex + 1];
        }
        
        return 'complete';
    }

    public function validateStepData(string $step, string $input): array
    {
        $result = ['valid' => false, 'data' => null, 'error' => null];
        
        switch ($step) {
            case 'start':
                // Para el paso start, solo aceptamos "S√ç" o "CANCELAR"
                if (strtoupper($input) === 'S√ç' || strtoupper($input) === 'SI') {
                    $result['valid'] = true;
                    $result['data'] = 'confirmed';
                } else {
                    $result['error'] = 'Escribe "S√ç" para continuar o "CANCELAR" para salir';
                }
                break;
                
            case 'ad_account':
                // Validar selecci√≥n de cuenta publicitaria
                $input = trim($input);
                if (is_numeric($input) && intval($input) >= 1) {
                    $result['valid'] = true;
                    $result['data'] = intval($input);
                } else {
                    $result['error'] = 'Selecciona un n√∫mero v√°lido de la lista';
                }
                break;
                
            case 'fanpage':
                // Validar selecci√≥n de fanpage
                $input = trim($input);
                if (is_numeric($input) && intval($input) >= 1) {
                    $result['valid'] = true;
                    $result['data'] = intval($input);
                } else {
                    $result['error'] = 'Selecciona un n√∫mero v√°lido de la lista';
                }
                break;
                
            case 'template_choice':
                // Validar elecci√≥n de m√©todo
                $input = strtolower(trim($input));
                if (in_array($input, ['paso', 'plantilla', 'template'])) {
                    $result['valid'] = true;
                    $result['data'] = $input;
                } else {
                    $result['error'] = 'Escribe "paso" para ir paso a paso o "plantilla" para usar plantilla';
                }
                break;
                
            case 'template_form':
                // Procesar plantilla
                $templateData = $this->parseTemplate($input);
                if ($templateData) {
                    $result['valid'] = true;
                    $result['data'] = $templateData;
                } else {
                    $result['error'] = 'Formato de plantilla inv√°lido. Usa el formato correcto con todos los campos requeridos.';
                }
                break;
                
            case 'campaign_name':
                if (strlen(trim($input)) >= 3) {
                    $result['valid'] = true;
                    $result['data'] = trim($input);
                } else {
                    $result['error'] = 'El nombre debe tener al menos 3 caracteres';
                }
                break;
                
            case 'campaign_objective':
                if (array_key_exists(strtoupper($input), $this->campaignObjectives)) {
                    $result['valid'] = true;
                    $result['data'] = strtoupper($input);
                } else {
                    $result['error'] = 'Objetivo no v√°lido. Usa uno de los c√≥digos disponibles';
                }
                break;
                
            case 'budget_type':
                if (in_array($input, array_keys($this->budgetTypes))) {
                    $result['valid'] = true;
                    $result['data'] = $input;
                } else {
                    $result['error'] = 'Tipo de presupuesto no v√°lido. Escribe "campaign" o "adset"';
                }
                break;
                
            case 'daily_budget':
                $budget = floatval($input);
                if ($budget > 0 && $budget <= 10000) {
                    $result['valid'] = true;
                    $result['data'] = $budget;
                } else {
                    $result['error'] = 'El presupuesto debe ser mayor a $0 y menor a $10,000 USD';
                }
                break;
                
            case 'dates':
                // Validar formato de fechas DD/MM/YYYY
                $dates = explode(' - ', $input);
                if (count($dates) === 2) {
                    $startDate = trim($dates[0]);
                    $endDate = trim($dates[1]);
                    
                    if (preg_match('/^\d{2}\/\d{2}\/\d{4}$/', $startDate) && 
                        preg_match('/^\d{2}\/\d{2}\/\d{4}$/', $endDate)) {
                        $result['valid'] = true;
                        $result['data'] = ['start' => $startDate, 'end' => $endDate];
                    } else {
                        $result['error'] = 'Formato de fecha inv√°lido. Usa DD/MM/YYYY';
                    }
                } else {
                    $result['error'] = 'Formato inv√°lido. Usa: DD/MM/YYYY - DD/MM/YYYY';
                }
                break;
                
            case 'geolocation':
                // Validar formato de geolocalizaci√≥n para Facebook
                $input = trim($input);
                if (strlen($input) >= 2) {
                    // Validar formato b√°sico: c√≥digos de pa√≠s (VE, US, ES) o ciudad,pa√≠s (Caracas,VE)
                    if (preg_match('/^[A-Z]{2}$/', $input) || // C√≥digo de pa√≠s (VE, US, ES)
                        preg_match('/^[A-Za-z\s]+,[A-Z]{2}$/', $input) || // Ciudad,Pa√≠s (Caracas,VE)
                        preg_match('/^[A-Z]{2};[A-Z]{2}$/', $input) || // M√∫ltiples pa√≠ses (VE;CO)
                        preg_match('/^[A-Za-z\s]+,[A-Z]{2};[A-Za-z\s]+,[A-Z]{2}$/', $input)) { // M√∫ltiples ciudades
                        $result['valid'] = true;
                        $result['data'] = $input;
                    } else {
                        $result['error'] = 'Formato de geolocalizaci√≥n inv√°lido. Usa c√≥digos de pa√≠s (VE, US, ES) o ciudad,pa√≠s (Caracas,VE)';
                    }
                } else {
                    $result['error'] = 'La geolocalizaci√≥n es requerida y debe tener al menos 2 caracteres';
                }
                break;
                
            case 'conversion_location':
                $input = trim(strtoupper($input));
                $validLocations = ['SITIO_WEB', 'APP', 'MESSENGER', 'WHATSAPP', 'FACEBOOK'];
                if (in_array($input, $validLocations)) {
                    $result['valid'] = true;
                    $result['data'] = $input;
                } else {
                    $result['error'] = 'Ubicaci√≥n de conversi√≥n no v√°lida. Usa: SITIO_WEB, APP, MESSENGER, WHATSAPP, o FACEBOOK';
                }
                break;
                
            case 'audience_type':
                if (in_array($input, array_keys($this->audienceTypes))) {
                    $result['valid'] = true;
                    $result['data'] = $input;
                } else {
                    $result['error'] = 'Tipo de audiencia no v√°lido';
                }
                break;
                
            case 'ad_placement':
                if (in_array($input, array_keys($this->adPlacements))) {
                    $result['valid'] = true;
                    $result['data'] = $input;
                } else {
                    $result['error'] = 'Ubicaci√≥n de anuncios no v√°lida. Escribe "automatic" o "manual"';
                }
                break;
                
            case 'creative_type':
                if (in_array($input, array_keys($this->creativeTypes))) {
                    $result['valid'] = true;
                    $result['data'] = $input;
                } else {
                    $result['error'] = 'Tipo de creativo no v√°lido';
                }
                break;
                
            case 'creative_content':
                if (strlen(trim($input)) >= 1) {
                    $result['valid'] = true;
                    $result['data'] = trim($input);
                } else {
                    $result['error'] = 'El contenido del creativo es requerido';
                }
                break;
                
            case 'ad_copy':
                if (strlen(trim($input)) >= 10) {
                    $result['valid'] = true;
                    $result['data'] = trim($input);
                } else {
                    $result['error'] = 'El copy del anuncio es requerido y debe tener al menos 10 caracteres';
                }
                break;
                
            case 'conversation_template':
                if (strlen(trim($input)) >= 1) {
                    $result['valid'] = true;
                    $result['data'] = trim($input);
                } else {
                    $result['error'] = 'La plantilla de conversaci√≥n es requerida';
                }
                break;
                
            case 'review':
                if (strtoupper($input) === 'CONFIRMAR') {
                    $result['valid'] = true;
                    $result['data'] = 'confirmed';
                } else {
                    $result['error'] = 'Escribe "CONFIRMAR" para crear la campa√±a o "EDITAR" para modificar algo';
                }
                break;
                
            default:
                $result['valid'] = true;
                $result['data'] = $input;
        }
        
        return $result;
    }

    public function getAvailableFacebookAccounts(): array
    {
        // Obtener cuentas reales de la API de Meta
        $facebookAccount = \App\Models\FacebookAccount::where('is_active', true)->first();
        
        if (!$facebookAccount) {
            return [];
        }
        
        $metaService = new \App\Services\MetaApiService();
        $adAccounts = $metaService->getAdAccounts($facebookAccount);
        
        // Formatear para el flujo
        $formatted = [];
        foreach ($adAccounts as $index => $account) {
            $formatted[] = [
                'id' => $index + 1,
                'account_name' => $account['name'],
                'app_id' => $account['id'],
                'access_token' => $facebookAccount->access_token,
                'currency' => $account['currency'],
                'status' => $account['status']
            ];
        }
        
        return $formatted;
    }

    public function getAvailableFanpages(?int $adAccountId = null): array
    {
        // Obtener fanpages reales de la API de Meta
        $facebookAccount = \App\Models\FacebookAccount::where('is_active', true)->first();
        
        if (!$facebookAccount) {
            return [];
        }
        
        $metaService = new \App\Services\MetaApiService();
        $pages = $metaService->getPages($facebookAccount);
        
        // Formatear para el flujo
        $formatted = [];
        foreach ($pages as $index => $page) {
            $formatted[] = [
                'id' => $index + 1,
                'page_name' => $page['name'],
                'page_id' => $page['id'],
                'category' => $page['category'],
                'access_token' => $page['access_token']
            ];
        }
        
        return $formatted;
    }

    /**
     * Obtener fanpages con paginaci√≥n
     */
    public function getFanpagesPaginated(int $page = 1, int $perPage = 20): array
    {
        $fanpages = $this->getAvailableFanpages();
        $total = count($fanpages);
        $offset = ($page - 1) * $perPage;
        
        return [
            'data' => array_slice($fanpages, $offset, $perPage),
            'current_page' => $page,
            'per_page' => $perPage,
            'total' => $total,
            'total_pages' => ceil($total / $perPage),
            'has_next' => $page < ceil($total / $perPage),
            'has_prev' => $page > 1
        ];
    }

    /**
     * Generar mensaje de fanpages con paginaci√≥n
     */
    public function getFanpageMessagePaginated(int $page = 1): string
    {
        $pagination = $this->getFanpagesPaginated($page);
        $fanpages = $pagination['data'];
        
        $message = "üì± *Paso 3: Seleccionar Fanpage*\n\n";
        $message .= "Selecciona la fanpage donde se publicar√° la campa√±a:\n\n";
        
        if (empty($fanpages)) {
            return $message . "‚ùå No hay fanpages disponibles.";
        }
        
        foreach ($fanpages as $index => $page) {
            $number = ($pagination['current_page'] - 1) * $pagination['per_page'] + $index + 1;
            $message .= "{$number}. *{$page['page_name']}*\n";
            $message .= "   ID: `{$page['page_id']}`\n";
            $message .= "   Categor√≠a: {$page['category']}\n";
            
            // Verificar si tiene cuenta de Instagram conectada
            if (isset($page['instagram_account'])) {
                $message .= "   üì∏ Instagram: @{$page['instagram_account']['username']}\n";
                $message .= "   üìä Seguidores: " . number_format($page['instagram_account']['followers_count']) . "\n";
            } else {
                $message .= "   üì∏ Instagram: No conectado\n";
            }
            $message .= "\n";
        }
        
        // Informaci√≥n de paginaci√≥n
        $message .= "üìÑ *P√°gina {$pagination['current_page']} de {$pagination['total_pages']}*\n";
        $message .= "üìä *Mostrando " . count($fanpages) . " de {$pagination['total']} fanpages*\n\n";
        
        // Navegaci√≥n
        if ($pagination['has_prev']) {
            $message .= "‚¨ÖÔ∏è *Escribe 'ANTERIOR' para ver la p√°gina anterior*\n";
        }
        if ($pagination['has_next']) {
            $message .= "‚û°Ô∏è *Escribe 'SIGUIENTE' para ver la p√°gina siguiente*\n";
        }
        
        $message .= "üí° *O escribe el n√∫mero de la fanpage que deseas usar.*";

        return $message;
    }
}
