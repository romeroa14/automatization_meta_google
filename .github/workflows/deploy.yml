name: Deploy Production

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
              # Usamos la ruta confirmada en el diagn√≥stico
              cd /opt/docker/laravel/app
              
              # Configuraci√≥n de seguridad de Git (fix para error dubious ownership)
              git config --global --add safe.directory /opt/docker/laravel/app

              # Corregir permisos (vital para evitar Permission denied)
              sudo chown -R adminvps:adminvps .
              
              # Poner en mantenimiento
              sudo docker exec -w /var/www/html laravel-php php artisan down || true
              
              # LIMPIEZA Y PREPARACI√ìN (Fix para conflictos de git)
              # Resetear cambios locales en archivos trackeados (como package-lock.json)
              git reset --hard HEAD
              # Eliminar archivos untracked que causan colisi√≥n (git clean respeta .gitignore, as√≠ que .env est√° seguro)
              git clean -fd

              # Pull del c√≥digo
              git pull origin master

              # ========== BACKEND ==========
              # Instalar dependencias (en el container)
              sudo docker exec -u application -w /var/www/html laravel-php composer install --no-dev --optimize-autoloader
              
              # Migraciones y limpieza (en el container)
              sudo docker exec -u application -w /var/www/html laravel-php php artisan migrate --force
              sudo docker exec -u application -w /var/www/html laravel-php php artisan config:clear
              sudo docker exec -u application -w /var/www/html laravel-php php artisan cache:clear
              sudo docker exec -u application -w /var/www/html laravel-php php artisan route:clear
              sudo docker exec -u application -w /var/www/html laravel-php php artisan view:clear

              # ========== FRONTEND ==========
              echo "üöÄ Actualizando frontend..."
              
              # Detener contenedor viejo del frontend
              sudo docker rm -f frontend-app || true
              
              # Reconstruir imagen del frontend SIN cache
              sudo docker-compose -f docker-compose.frontend.yml build --no-cache frontend-app
              
              # Levantar nuevo contenedor
              sudo docker-compose -f docker-compose.frontend.yml up -d frontend-app
              
              echo "‚úÖ Frontend actualizado correctamente"

              # Levantar sitio
              sudo docker exec -u application -w /var/www/html laravel-php php artisan up

              # Reiniciar contenedor de PHP para limpiar OPcache
              sudo docker restart laravel-php

              echo "‚úÖ Despliegue autom√°tico completado."
