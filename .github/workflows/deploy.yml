name: Deploy Production

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
              # Usamos la ruta confirmada en el diagnóstico
              cd /opt/docker/laravel/app
              
              # Configuración de seguridad de Git (fix para error dubious ownership)
              git config --global --add safe.directory /opt/docker/laravel/app

              # Corregir permisos (vital para evitar Permission denied)
              sudo chown -R adminvps:adminvps .
              
              # Poner en mantenimiento
              sudo docker exec -w /var/www/html laravel-php php artisan down || true
              
              # LIMPIEZA Y PREPARACIÓN (Fix para conflictos de git)
              # Resetear cambios locales en archivos trackeados (como package-lock.json)
              git reset --hard HEAD
              # Eliminar archivos untracked que causan colisión (git clean respeta .gitignore, así que .env está seguro)
              git clean -fd
              
              # Pull del código
              git pull origin master
              
              # Instalar dependencias (en el container)
              sudo docker exec -u application -w /var/www/html laravel-php composer install --no-dev --optimize-autoloader
              
              # Migraciones y limpieza (en el container)
              sudo docker exec -u application -w /var/www/html laravel-php php artisan migrate --force
              sudo docker exec -u application -w /var/www/html laravel-php php artisan config:clear
              sudo docker exec -u application -w /var/www/html laravel-php php artisan cache:clear
              sudo docker exec -u application -w /var/www/html laravel-php php artisan route:clear
              sudo docker exec -u application -w /var/www/html laravel-php php artisan view:clear
              
              # Levantar sitio
              sudo docker exec -u application -w /var/www/html laravel-php php artisan up
              
              # Reiniciar contenedor de PHP para limpiar OPcache
              sudo docker restart laravel-php
              
              echo "✅ Despliegue automático completado."
