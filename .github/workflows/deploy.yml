name: Deploy Production

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
              # Ruta del proyecto
              cd /var/www/html/admetricas.com
              
              # ConfiguraciÃ³n de seguridad de Git
              git config --global --add safe.directory /var/www/html/admetricas.com

              # Corregir permisos de archivos gitignore PRIMERO (evita error de git reset)
              chown -R adminvps:adminvps bootstrap/cache/.gitignore storage/app/.gitignore storage/app/private/.gitignore storage/app/public/.gitignore storage/framework/.gitignore storage/framework/cache/.gitignore storage/framework/cache/data/.gitignore storage/framework/sessions/.gitignore storage/framework/testing/.gitignore storage/framework/views/.gitignore storage/logs/.gitignore 2>/dev/null || true
              chmod 644 bootstrap/cache/.gitignore storage/app/.gitignore storage/app/private/.gitignore storage/app/public/.gitignore storage/framework/.gitignore storage/framework/cache/.gitignore storage/framework/cache/data/.gitignore storage/framework/sessions/.gitignore storage/framework/testing/.gitignore storage/framework/views/.gitignore storage/logs/.gitignore 2>/dev/null || true

              # Poner en mantenimiento
              docker exec -w /var/www/html laravel-php php artisan down || true

              # Resetear y clean (sin sudo)
              git reset --hard HEAD
              git clean -fd

              # Pull del cÃ³digo
              git pull origin master

              # ========== BACKEND ==========
              # Instalar dependencias (sin sudo)
              docker exec -u application -w /var/www/html laravel-php composer install --no-dev --optimize-autoloader
              
              # Migraciones
              docker exec -u application -w /var/www/html laravel-php php artisan migrate --force
              docker exec -u application -w /var/www/html laravel-php php artisan config:clear
              docker exec -u application -w /var/www/html laravel-php php artisan cache:clear
              docker exec -u application -w /var/www/html laravel-php php artisan route:clear
              docker exec -u application -w /var/www/html laravel-php php artisan view:clear

              # ========== FRONTEND ==========
              echo "ðŸš€ Actualizando frontend..."

              # Detener contenedor viejo (sin sudo)
              docker rm -f frontend-app 2>/dev/null || true

              # Habilitar BuildKit
              export DOCKER_BUILDKIT=1

              # Reconstruir imagen CON cache
              docker-compose -f docker-compose.frontend.yml build --progress=plain frontend-app

              # Levantar nuevo contenedor
              docker-compose -f docker-compose.frontend.yml up -d frontend-app
              
              echo "âœ… Frontend actualizado correctamente"

              # Levantar sitio
              docker exec -u application -w /var/www/html laravel-php php artisan up

              # Reiniciar PHP para limpiar OPcache
              docker restart laravel-php

              echo "âœ… Despliegue completado exitosamente"
